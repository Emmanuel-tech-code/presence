<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDEJ EPHPHATHA</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
body{
height:100vh;
background:linear-gradient(135deg,#87CEEB,#E0F7FA,#ffffff);
margin:0;
overflow:hidden;
position:relative;
}
body::before{
content:'';
position:absolute;
top:0;left:0;right:0;bottom:0;
background:radial-gradient(circle at 20% 80%, rgba(120,219,255,0.3) 0%, transparent 50%),
radial-gradient(circle at 80% 20%, rgba(255,255,255,0.3) 0%, transparent 50%);
animation: float 20s ease-in-out infinite;
}
@keyframes float{
0%,100%{transform:translateY(0) rotate(0deg);}
50%{transform:translateY(-20px) rotate(2deg);}
}
.container{width:100%;height:100vh;display:flex;flex-direction:column}
.header{
background:linear-gradient(135deg,#ffffff, #f8f9ff);
padding:15px 25px;
display:flex;
justify-content:space-between;
align-items:center;
box-shadow:0 8px 32px rgba(135,206,235,0.3);
backdrop-filter:blur(10px);
border-bottom:1px solid rgba(255,255,255,0.2);
transition:all 0.3s ease;
}
.header:hover{box-shadow:0 12px 40px rgba(135,206,235,0.4);}
.logo{
width:50px;
height:50px;
border-radius:15px;
object-fit:cover;
transition:transform 0.3s ease, box-shadow 0.3s ease;
box-shadow:0 4px 15px rgba(135,206,235,0.4);
}
.logo:hover{
transform:scale(1.1) rotate(5deg);
box-shadow:0 8px 25px rgba(135,206,235,0.6);
}
.content{
flex:1;
display:flex;
justify-content:center;
align-items:center;
padding:20px;
}
.card{
background: transparent;
width:100%;
max-width:none;
padding:40px;
border-radius:0px;
box-shadow:0 20px 60px rgba(135,206,235,0.4), 0 0 0 1px rgba(255,255,255,0.5);
backdrop-filter:blur(20px);
transition:all 0.4s cubic-bezier(0.25,0.46,0.45,0.94);
position:relative;
overflow:hidden;
}
.card::before{
content:'';
position:absolute;
top:0;left:0;right:0;height:4px;
background:linear-gradient(90deg,#87CEEB,#0077b6,#87CEEB);
animation: shimmer 3s infinite;
}
@keyframes shimmer{
0%{transform:translateX(-100%);}
100%{transform:translateX(100%);}
}
.card:hover{
transform:translateY(-10px);
box-shadow:0 30px 80px rgba(135,206,235,0.6);
}
input{
width:100%;
padding:15px 20px;
margin-bottom:15px;
border-radius:15px;
border:2px solid transparent;
background:linear-gradient(145deg,#ffffff, #f0f8ff);
transition:all 0.3s ease;
font-size:16px;
}
input:focus{
outline:none;
border-color:#87CEEB;
box-shadow:0 0 0 4px rgba(135,206,235,0.2);
transform:translateY(-2px);
}
input:valid{ border-color:#4CAF50; }
button{
width:100%;
padding:15px 20px;
border:none;
border-radius:15px;
background:linear-gradient(135deg,#87CEEB,#0077b6);
color:white;
font-size:16px;
font-weight:600;
margin-top:15px;
cursor:pointer;
transition:all 0.3s cubic-bezier(0.25,0.46,0.45,0.94);
position:relative;
overflow:hidden;
}
button::before{
content:'';
position:absolute;
top:0;left:-100%;width:100%;height:100%;
background:linear-gradient(90deg,transparent, rgba(255,255,255,0.3),transparent);
transition:left 0.5s;
}
button:hover::before{left:100%;}
button:hover{
transform:translateY(-3px);
box-shadow:0 15px 40px rgba(135,206,235,0.6);
}
button:active{transform:translateY(-1px);}
.hidden{display:none}
.personItem{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:12px;
padding:15px 20px;
border:2px solid transparent;
border-radius:15px;
background:linear-gradient(145deg,#ffffff, #f8f9ff);
transition:all 0.3s ease;
cursor:pointer;
}
.personItem:hover{
border-color:#87CEEB;
transform:translateX(5px);
box-shadow:0 10px 30px rgba(135,206,235,0.3);
}
.logo-login{
width:120px;
height:120px;
border-radius:25px;
object-fit:cover;
margin:0 auto 25px;
display:block;
box-shadow:0 15px 40px rgba(135,206,235,0.5);
transition:transform 0.4s ease, box-shadow 0.4s ease;
}
.logo-login:hover{
transform:scale(1.05) rotate(2deg);
box-shadow:0 25px 60px rgba(135,206,235,0.7);
}
.date-field {
    padding: 14px;
    border-radius: 15px;
    border: 2px solid #87CEEB;
    background: #f0f8ff;
    font-size: 16px;
    margin: 15px 0;
    width: 100%;
}

/* Ajouts pour la gestion */
.button-group { display: flex; gap: 12px; margin-top: 20px; }
.button-group button { flex: 1; }
.delete-btn { background: linear-gradient(135deg, #f44336, #d32f2f) !important; }
.edit-btn   { background: linear-gradient(135deg, #ff9800, #f57c00) !important; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="content">
<div class="card">
<div style="text-align:center;margin-bottom:30px;">
<img src="logo.png" alt="CDEJEPH Logo" class="logo-login">
<h2 style="color:#0077b6;font-size:28px;margin-bottom:10px;">Bienvenue</h2>
<p style="color:#666;font-size:14px;">Entrez le mot de passe pour continuer</p>
</div>
<input type="password" id="pass" placeholder="Mot de passe">
<button onclick="login()">Entrer</button>
</div>
</div>

<!-- MENU -->
<div id="menu" class="hidden container">
<div class="header">
<img src="logo.png" alt="Logo" class="logo">
<h2 style="color:#0077b6;margin:0;">CDEJ EPHPHATHA</h2>
</div>
<div class="content">
<div class="card">
<button onclick="show('add')">Ajouter Personne</button>
<button onclick="show('manage')">G√©rer les personnes</button>
<button onclick="show('presence')">Marquer Pr√©sence</button>
<button onclick="show('list')">Voir Pr√©sents</button>
<button onclick="logout()">D√©connexion</button>
</div>
</div>
</div>

<!-- AJOUT -->
<div id="add" class="hidden container">
<div class="header">
<img src="logo.png" alt="Logo" class="logo">
<h2>Ajouter Personne</h2>
</div>
<div class="content">
<div class="card" style="max-height:500px; overflow-y:auto;">
<input id="nom" placeholder="Nom *" required>
<input id="prenom" placeholder="Pr√©nom *" required>
<input id="age" placeholder="Age">
<input id="ecole" placeholder="Ecole">
<input id="classe" placeholder="Classe">
<input id="parents" placeholder="Num√©ro Parents">
<input id="tg" placeholder="Num√©ro TG *" required>
<input id="metier" placeholder="M√©tier avenir">

<div class="button-group">
    <button onclick="savePerson()">Enregistrer</button>
    <button onclick="back()" style="background:linear-gradient(135deg,#ff9800,#f57c00);">Retour</button>
</div>
</div>
</div>
</div>

<!-- NOUVELLE SECTION : G√âRER LES PERSONNES -->
<div id="manage" class="hidden container">
<div class="header">
<img src="logo.png" alt="Logo" class="logo">
<h2>G√©rer les personnes</h2>
</div>
<div class="content">
<div class="card" style="max-height:500px; overflow-y:auto;">
<div id="manageList" style="max-height:420px;overflow-y:auto;margin-bottom:20px;"></div>
<button onclick="back()" style="background:linear-gradient(135deg,#ff9800,#f57c00);">‚Ü©Ô∏è Retour</button>
</div>
</div>
</div>

<!-- PRESENCE -->
<div id="presence" class="hidden container">
<div class="header">
<img src="logo.png" alt="Logo" class="logo">
<h2>Marquer Pr√©sence</h2>
</div>
<div class="content">
<div class="card" style="max-height:500px; overflow-y:auto;">
<input id="searchInput" placeholder="Rechercher par Nom ou TG...">
<button onclick="searchPerson()">Rechercher</button>
<div id="personList" style="margin-top:25px;max-height:400px;overflow-y:auto;"></div>
<button onclick="back()" style="background:linear-gradient(135deg,#ff9800,#f57c00);">‚Ü©Ô∏è Retour</button>
</div>
</div>
</div>

<!-- LISTE ‚Äì avec choix de date + PDF -->
<div id="list" class="hidden container">
<div class="header">
<img src="logo.png" alt="Logo" class="logo">
<h2>Pr√©sents</h2>
</div>
<div class="content">
<div class="card" style="max-height:500px; overflow-y:auto;">
<label style="display:block; margin-bottom:8px; color:#0077b6; font-weight:bold;">Date √† exporter :</label>
<input type="date" id="exportDate" class="date-field">
<div id="result" style="margin:20px 0; max-height:320px; overflow-y:auto;"></div>
<button onclick="downloadPDF()">üìÑ T√©l√©charger PDF</button>
<button onclick="back()" style="background:linear-gradient(135deg,#ff9800,#f57c00);">‚Ü©Ô∏è Retour</button>
</div>
</div>
</div>

<script>
// CONFIG FIREBASE
var firebaseConfig = {
    apiKey: "AIzaSyCqdm2lbOtt5VOo6OcH2LV0ep3ZcxQiFGs",
    authDomain: "cdej-47315.firebaseapp.com",
    projectId: "cdej-47315"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

// REFERENCES
const loginPage = document.getElementById("login");
const menu = document.getElementById("menu");
const add = document.getElementById("add");
const manage = document.getElementById("manage");
const presence = document.getElementById("presence");
const list = document.getElementById("list");
const personList = document.getElementById("personList");
const manageList = document.getElementById("manageList");
const result = document.getElementById("result");
const exportDate = document.getElementById("exportDate");

const nom = document.getElementById("nom");
const prenom = document.getElementById("prenom");
const age = document.getElementById("age");
const ecole = document.getElementById("ecole");
const classe = document.getElementById("classe");
const parents = document.getElementById("parents");
const enfants = document.getElementById("enfants");    
const tg = document.getElementById("tg");
const metier = document.getElementById("metier");

const pass = document.getElementById("pass");
const searchInput = document.getElementById("searchInput");

// LOGIN
function login(){
    if(pass.value === "CDEJ@EPH12"){
        loginPage.classList.add("hidden");
        menu.classList.remove("hidden");
        pass.value = "";
    }else{
        alert("Mot de passe incorrect, r√©essayer");
    }
}

function logout(){
    menu.classList.add("hidden");
    loginPage.classList.remove("hidden");
}

function show(id){
    menu.classList.add("hidden");
    document.getElementById(id).classList.remove("hidden");
    if(id === "presence"){ loadPersons(); }
    if(id === "list"){ loadForDate(); }
    if(id === "manage"){ loadManageList(); }
}

function back(){
    add.classList.add("hidden");
    manage.classList.add("hidden");
    presence.classList.add("hidden");
    list.classList.add("hidden");
    menu.classList.remove("hidden");
}

// AJOUT PERSONNE
function savePerson(){

    if(!nom.value.trim() || !prenom.value.trim() || !tg.value.trim()){
        alert("Nom, Pr√©nom et Num√©ro TG sont obligatoires");
        return;
    }

    let tgValue = tg.value.trim();

    let docRef = db.collection("personnes").doc(tgValue);

    // üîé V√©rifier si le TG existe d√©j√†
    docRef.get().then((doc)=>{
        
        if(doc.exists){
            alert("‚ö†Ô∏è Cette personne est d√©j√† enregistr√©e !");
            return;
        }

        // ‚úÖ On enregistre avec TG comme ID
        docRef.set({
            nom: nom.value.trim(),
            prenom: prenom.value.trim(),
            age: age.value.trim() || "",
            ecole: ecole.value.trim() || "",
            classe: classe.value.trim() || "",
            parents: parents.value.trim() || "",
            enfants: enfants.value.trim() || "",
            tg: tgValue,
            metier: metier.value.trim() || ""
        }).then(()=>{
            alert("Personne enregistr√©e avec succ√®s !");
            [nom, prenom, age, ecole, classe, parents, enfants, tg, metier]
            .forEach(i => i.value = "");
        });

    }).catch((error)=>{
        console.error(error);
        alert("Erreur lors de l'enregistrement");
    });
}


    db.collection("personnes").add({
        nom: nom.value.trim(),
        prenom: prenom.value.trim(),
        age: age.value.trim() || "",
        ecole: ecole.value.trim() || "",
        classe: classe.value.trim() || "",
        parents: parents.value.trim() || "",
        enfants: enfants.value.trim() || "",
        tg: tg.value.trim(),
        metier: metier.value.trim() || ""
    }).then(()=>{
        alert("‚úÖ Personne enregistr√©e avec succ√®s !");
        [nom, prenom, age, ecole, classe, parents,enfants, tg, metier].forEach(i => i.value = "");
    }).catch(error => {
        alert(" Erreur lors de l'enregistrement");
        console.error(error);
        
    });
}

// CHARGER PERSONNES pour pr√©sence
function loadPersons(){
    personList.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">Chargement...</p>';
    db.collection("personnes").get().then(snapshot => {
        personList.innerHTML = "";
        if(snapshot.empty){
            personList.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">Aucune personne enregistr√©e</p>';
            return;
        }
        snapshot.forEach(doc => {
            let data = doc.data();
            personList.innerHTML += `
            <div class="personItem">
                <span><strong>${data.nom} ${data.prenom}</strong><br>
                <small>TG: ${data.tg}</small></span>
                <button onclick='savePresence("${data.nom}","${data.prenom}","${data.tg}")'
                style="background:linear-gradient(135deg,#4CAF50,#45a049);padding:10px 20px;">‚úÖ</button>
            </div>`;
        });
    });
}

// RECHERCHE (inchang√©e)
function searchPerson(){
    let value = searchInput.value.toLowerCase().trim();
    if(value.length < 2){ loadPersons(); return; }
    personList.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">Recherche...</p>';
    db.collection("personnes").get().then(snapshot => {
        personList.innerHTML = "";
        let found = false;
        snapshot.forEach(doc => {
            let data = doc.data();
            if(data.nom.toLowerCase().includes(value) ||
               data.prenom.toLowerCase().includes(value) ||
               data.tg.toLowerCase().includes(value)){
                personList.innerHTML += `
                <div class="personItem">
                    <span><strong>${data.nom} ${data.prenom}</strong><br>
                    <small>TG: ${data.tg}</small></span>
                    <button onclick='savePresence("${data.nom}","${data.prenom}","${data.tg}")'
                    style="background:linear-gradient(135deg,#4CAF50,#45a049);padding:10px 20px;">‚úÖ</button>
                </div>`;
                found = true;
            }
        });
        if(!found){
            personList.innerHTML = '<p style="text-align:center;color:#f44336;padding:40px;">Aucun r√©sultat trouv√©</p>';
        }
    });
}

// ENREGISTRER PRESENCE
function savePresence(nom, prenom, tg){

    let now = new Date();
    let dateStr = now.toLocaleDateString('fr-FR');
    let heureStr = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});

    // üîé V√©rifier si la personne est d√©j√† pr√©sente aujourd‚Äôhui
    db.collection("presences")
      .where("tg", "==", tg)
      .where("date", "==", dateStr)
      .get()
      .then(snapshot => {

        if(!snapshot.empty){
            alert("Cette personne est d√©j√† marqu√©e pr√©sente aujourd‚Äôhui !");
            return;
        }

        // ‚úÖ Sinon on enregistre
        db.collection("presences").add({
            nom: nom + " " + prenom,
            tg: tg,
            date: dateStr,
            heure: heureStr
        }).then(() => {
            alert("Pr√©sence enregistr√©e !");
            loadPersons(); // Recharge la liste
        });

      })
      .catch(error => {
          console.error(error);
      });
}


// CHARGER LISTE pour la date s√©lectionn√©e
function loadForDate(){
    let selected = exportDate.value;
    let dateToUse = selected ? new Date(selected).toLocaleDateString('fr-FR') : new Date().toLocaleDateString('fr-FR');

    result.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">Chargement...</p>';

    db.collection("presences")
      .where("date", "==", dateToUse)
      .get()
      .then(snapshot => {
        result.innerHTML = "";
        if(snapshot.empty){
            result.innerHTML = '<p style="text-align:center;color:#666;font-style:italic;padding:40px;">Aucune pr√©sence pour cette date</p>';
            return;
        }
        let count = snapshot.size;
        let html = `<h3 style="margin-bottom:20px;color:#0077b6;">${count} pr√©sent(s) le ${dateToUse}</h3>`;
        snapshot.forEach(doc => {
            let d = doc.data();
            html += `<div class="personItem">
                <span><strong>${d.nom}</strong><br><small>${d.heure}</small></span>
            </div>`;
        });
        result.innerHTML = html;
      });
}

// TELECHARGER PDF
function downloadPDF(){
    let selected = exportDate.value;
    if(!selected){
        alert("Veuillez s√©lectionner une date !");
        return;
    }
    let dateObj = new Date(selected);
    let dateFr = dateObj.toLocaleDateString('fr-FR');

    db.collection("presences")
      .where("date", "==", dateFr)
      .get()
      .then(snapshot => {
        if(snapshot.empty){
            alert("Aucune pr√©sence pour cette date.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text(`Pr√©sences CDEJEPH - ${dateFr}`, 15, 20);

        let tableData = [];
        snapshot.forEach(doc => {
            let d = doc.data();
            tableData.push([
                d.tg || "‚Äî",
                d.heure || "‚Äî",
                d.nom || "‚Äî"
            ]);
        });

        doc.autoTable({
            head: [['Num TG', 'Heure', 'Nom et Pr√©noms']],
            body: tableData,
            startY: 30,
            theme: 'grid',
            headStyles: { fillColor: [135, 206, 235], textColor: 0, fontStyle: 'bold' },
            styles: { fontSize: 10, cellPadding: 5, overflow: 'linebreak' },
            columnStyles: {
                0: { cellWidth: 40 },
                1: { cellWidth: 40 },
                2: { cellWidth: 100 }
            }
        });

        doc.save(`presence_${dateFr.replace(/\//g, '-')}.pdf`);
      })
      .catch(err => {
        console.error(err);
        alert("Erreur lors de la g√©n√©ration du PDF");
      });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NOUVEAU : Gestion (modifier / supprimer)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadManageList() {
    manageList.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">Chargement...</p>';
    
    db.collection("personnes").orderBy("nom").get().then(snapshot => {
        manageList.innerHTML = "";
        if (snapshot.empty) {
            manageList.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">Aucune personne enregistr√©e</p>';
            return;
        }
        snapshot.forEach(doc => {
            let data = doc.data();
            let id = doc.id;
            manageList.innerHTML += `
            <div class="personItem">
                <span><strong>${data.nom} ${data.prenom}</strong><br>
                <small>TG: ${data.tg} ‚Ä¢ ${data.age || ''} ans ‚Ä¢ ${data.ecole || ''}</small></span>
                <div style="display:flex;gap:10px;">
                    <button class="edit-btn" onclick="editPerson('${id}', '${escape(data.nom)}', '${escape(data.prenom)}', '${escape(data.age||'')}', '${escape(data.ecole||'')}', '${escape(data.classe||'')}', '${escape(data.parents||'')}', '${escape(data.tg)}', '${escape(data.metier||'')}')">Modifier</button>
                    <button class="delete-btn" onclick="deletePerson('${id}', '${escape(data.nom + ' ' + data.prenom)}')">Supprimer</button>
                </div>
            </div>`;
        });
    }).catch(err => {
        manageList.innerHTML = '<p style="color:red;text-align:center;">Erreur de chargement</p>';
        console.error(err);
    });
}

function escape(str) {
    return str.replace(/'/g, "\\'");
}

function editPerson(id, nom, prenom, age, ecole, classe, parents, enfants, tg, metier) {
    const newNom    = prompt("Nom :", nom)     || nom;
    const newPrenom = prompt("Pr√©nom :", prenom)  || prenom;
    const newAge    = prompt("Age :", age)     || age;
    const newEcole  = prompt("Ecole :", ecole)   || ecole;
    const newClasse = prompt("Classe :", classe)  || classe;
    const newParents= prompt("Num Parents :", parents)|| parents;
    const newenfants= prompt("Num secondaire :", enfants)|| enfants;
    const newTg     = prompt("Num TG :", tg)      || tg;
    const newMetier = prompt("M√©tier avenir :", metier)|| metier;

    if (!newNom.trim() || !newPrenom.trim() || !newTg.trim()) {
        alert("Nom, Pr√©nom et TG sont obligatoires !");
        return;
    }

    db.collection("personnes").doc(id).update({
        nom: newNom.trim(),
        prenom: newPrenom.trim(),
        age: newAge.trim(),
        ecole: newEcole.trim(),
        classe: newClasse.trim(),
        parents: newParents.trim(),
         parents: newenfants.trim(),
        tg: newTg.trim(),
        metier: newMetier.trim()
    }).then(() => {
        alert("Modifications enregistr√©es");
        loadManageList();
    }).catch(err => {
        alert("Erreur lors de la modification");
        console.error(err);
    });
}

function deletePerson(id, fullName) {
    if (!confirm(`Supprimer d√©finitivement ${fullName} ?`)) return;

    db.collection("personnes").doc(id).delete()
    .then(() => {
        alert("Personne supprim√©e");
        loadManageList();
    })
    .catch(err => {
        alert("Erreur lors de la suppression");
        console.error(err);
    });
}

// Initialisation date par d√©faut = aujourd'hui
exportDate.valueAsDate = new Date();
</script>
</body>
</html>



